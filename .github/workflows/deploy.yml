name: Deploy to Production

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/dhlshipping
            
            # Pull latest code
            git pull origin main
            
            # Build and deploy
            docker compose -f docker-compose.prod.yml build
            docker compose -f docker-compose.prod.yml up -d
            
            # Wait for health checks
            sleep 10
            
            # Check container status
            docker compose -f docker-compose.prod.yml ps
            
            # Initialize database if needed
            docker exec dhl-backend-prod npm run init-data || true
            
            echo "Deployment completed successfully!"
      
      - name: Health Check
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Check backend health
            BACKEND_HEALTH=$(docker inspect dhl-backend-prod --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
            FRONTEND_HEALTH=$(docker inspect dhl-frontend-prod --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")
            
            echo "Backend Health: $BACKEND_HEALTH"
            echo "Frontend Health: $FRONTEND_HEALTH"
            
            if [ "$BACKEND_HEALTH" != "healthy" ] || [ "$FRONTEND_HEALTH" != "healthy" ]; then
              echo "⚠️ Warning: Some containers are not healthy"
              docker compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
            
            echo "✅ All containers are healthy!"


